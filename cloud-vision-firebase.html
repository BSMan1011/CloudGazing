<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#87CEEB">
    <title>Cloud Vision - Global</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(to bottom, #87CEEB 0%, #E0F6FF 100%);
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            font-size: 1.8em;
            margin: 10px 0;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.8);
        }

        .subtitle {
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin: 15px 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab {
            padding: 10px 15px;
            background: white;
            border: none;
            border-radius: 20px;
            white-space: nowrap;
            font-size: 0.9em;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tab.active {
            background: #3498db;
            color: white;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        .canvas-box {
            position: relative;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        #cloudImg {
            width: 100%;
            display: block;
            max-height: 60vh;
            object-fit: contain;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            touch-action: none;
        }

        .tools {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }

        .tool-row {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 15px;
            border: 2px solid #3498db;
            background: white;
            color: #2c3e50;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            flex: 1;
            min-width: 70px;
        }

        .btn.active {
            background: #3498db;
            color: white;
        }

        input[type="color"] {
            width: 50px;
            height: 40px;
            border: 2px solid #3498db;
            border-radius: 8px;
            cursor: pointer;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #3498db;
            border-radius: 8px;
            font-size: 1em;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 10px;
        }

        .submit {
            width: 100%;
            padding: 15px;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
        }

        .submit:disabled {
            background: #95a5a6;
        }

        .gallery {
            display: grid;
            gap: 15px;
        }

        .card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .card-body {
            padding: 15px;
        }

        .admin-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #3498db;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .image-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
        }

        .image-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
        }

        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(231,76,60,0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 18px;
            cursor: pointer;
        }

        .info {
            background: #ecf0f1;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-box {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <h1>üå§Ô∏è Cloud Vision</h1>
    <p class="subtitle">Share what you see in the clouds - globally!</p>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('draw')">Draw</button>
        <button class="tab" onclick="switchTab('gallery')">Gallery</button>
        <button class="tab" onclick="switchTab('stats')">Stats</button>
        <button class="tab" onclick="switchTab('manage')">Manage</button>
    </div>

    <!-- Draw View -->
    <div id="draw" class="view active">
        <div class="canvas-box">
            <img id="cloudImg" src="https://images.unsplash.com/photo-1517483000871-1dbf64a6e1c6?w=800&q=80" alt="Cloud">
            <canvas id="canvas"></canvas>
        </div>

        <div class="tools">
            <div style="background: #ecf0f1; padding: 8px 12px; border-radius: 8px; margin-bottom: 10px; font-size: 0.9em; text-align: center;">
                üë§ Posting as: <strong id="currentUsername">Anonymous</strong>
                <button onclick="switchTab('manage'); document.querySelectorAll('.tab')[3].click();" style="background: none; border: none; color: #3498db; cursor: pointer; text-decoration: underline; font-size: 0.85em; margin-left: 5px;">change</button>
            </div>
            
            <div class="tool-row">
                <button class="btn active" onclick="setTool('draw')">‚úèÔ∏è Draw</button>
                <button class="btn" onclick="setTool('erase')">üßπ Erase</button>
                <input type="color" id="color" value="#ff0000">
                <div style="display: flex; align-items: center; gap: 5px; flex: 1; min-width: 100px;">
                    <span style="font-size: 0.8em; color: #7f8c8d;">Size:</span>
                    <input type="range" id="brushSize" min="1" max="20" value="3" onchange="setBrushSize(this.value)" style="flex: 1;">
                </div>
                <button class="btn" onclick="undo()" id="undoBtn">‚Ü∂ Undo</button>
                <button class="btn" onclick="redo()" id="redoBtn">‚Ü∑ Redo</button>
                <button class="btn" onclick="clearCanvas()">Clear</button>
                <button class="btn" onclick="nextImage()">Next</button>
            </div>
            
            <textarea id="desc" placeholder="What do you see? (e.g., a dragon, a face, a castle...)"></textarea>
            
            <button class="submit" onclick="submit()">Submit Your Vision</button>
        </div>
    </div>

    <!-- Gallery View -->
    <div id="gallery" class="view">
        <div style="margin-bottom: 15px;">
            <button class="btn" style="width: 100%; background: #3498db; color: white; border-color: #3498db;" onclick="document.querySelectorAll('.tab')[0].click()">
                ‚¨ÖÔ∏è Back to Drawing
            </button>
        </div>
        <div class="gallery" id="galleryList">
            <div class="loading">Loading visions...</div>
        </div>
    </div>

    <!-- Stats View -->
    <div id="stats" class="view">
        <div style="margin-bottom: 15px;">
            <button class="btn" style="width: 100%; background: #3498db; color: white; border-color: #3498db;" onclick="document.querySelectorAll('.tab')[0].click()">
                ‚¨ÖÔ∏è Back to Drawing
            </button>
        </div>
        <div class="tools">
            <h3 style="margin-bottom: 15px;">üìä Global Statistics</h3>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-number" id="totalVisions">-</div>
                    <div class="stat-label">Total Visions</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="uniqueImages">-</div>
                    <div class="stat-label">Cloud Images</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="todayVisions">-</div>
                    <div class="stat-label">Today</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="avgMatches">-</div>
                    <div class="stat-label">Avg Matches</div>
                </div>
            </div>
            <div id="topThings"></div>
        </div>
    </div>

    <!-- Manage View -->
    <div id="manage" class="view">
        <div class="tools">
            <h3 style="margin-bottom: 10px;">Manage Images</h3>
            
            <div class="info">
                <strong>Your Username:</strong>
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                    <input type="text" id="usernameInput" class="admin-input" style="margin: 0; flex: 1;" placeholder="Anonymous">
                    <button class="btn" onclick="saveUsername()" style="width: auto; padding: 12px 20px;">Save</button>
                </div>
            </div>

            <div class="info">
                <label>
                    <input type="checkbox" id="communityToggle" onchange="toggleCommunity(this.checked)">
                    Allow community uploads
                </label>
            </div>

            <input type="text" class="admin-input" id="urlInput" placeholder="Paste image URL...">
            <button class="btn" style="width: 100%; margin-bottom: 10px;" onclick="addUrl()">Add URL</button>

            <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="addFile(this)">
            <button class="btn" style="width: 100%; margin-bottom: 10px;" onclick="document.getElementById('fileInput').click()">üì∏ Upload Photo</button>

            <h4 style="margin: 15px 0 10px;">Cloud Images (<span id="count">0</span>)</h4>
            <div class="image-grid" id="imageGrid"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, deleteDoc, doc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDgm6wzwFqyPx0QaSUfIFwwNQ8WcKlQ3pY",
            authDomain: "cloudgazing-88e26.firebaseapp.com",
            projectId: "cloudgazing-88e26",
            storageBucket: "cloudgazing-88e26.firebasestorage.app",
            messagingSenderId: "1068852664251",
            appId: "1:1068852664251:web:5ae16467abe5abd152969e",
            measurementId: "G-BFWS5LQ9W2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db;
        window.firestore = { collection, addDoc, getDocs, query, orderBy, limit, deleteDoc, doc, serverTimestamp };

        console.log('‚úÖ Firebase connected!');
        
        // Load initial data
        loadImages();
        loadVisions();
        loadStats();
    </script>

    <script>
        let canvas, ctx, drawing = false;
        let tool = 'draw', color = '#ff0000';
        let brushSize = 3;
        let images = [];
        let currentIdx = 0;
        let allVisions = [];
        let drawingHistory = [];
        let historyStep = -1;

        function init() {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            
            const img = document.getElementById('cloudImg');
            img.onload = resize;
            
            canvas.addEventListener('touchstart', start);
            canvas.addEventListener('touchmove', move);
            canvas.addEventListener('touchend', stop);
            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', move);
            canvas.addEventListener('mouseup', stop);
            
            // Initialize with blank state
            saveState();
        }

        function resize() {
            const img = document.getElementById('cloudImg');
            const oldData = canvas.toDataURL('image/png');
            canvas.width = img.offsetWidth;
            canvas.height = img.offsetHeight;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            // Restore if had content
            if (drawingHistory.length > 0) {
                const tempImg = new Image();
                tempImg.onload = () => {
                    ctx.drawImage(tempImg, 0, 0);
                };
                tempImg.src = oldData;
            }
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches ? e.touches[0] : e;
            return {
                x: touch.clientX - rect.left,
                y: touch.clientY - rect.top
            };
        }

        function start(e) {
            e.preventDefault();
            drawing = true;
            const pos = getPos(e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }

        function move(e) {
            if (!drawing) return;
            e.preventDefault();
            
            const pos = getPos(e);
            
            if (tool === 'erase') {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.lineWidth = brushSize * 3;
            } else {
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = document.getElementById('color').value;
                ctx.lineWidth = brushSize;
            }
            
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
        }

        function setBrushSize(size) {
            brushSize = parseInt(size);
        }

        function stop() {
            if (drawing) {
                drawing = false;
                saveState();
            }
        }

        function saveState() {
            // Remove any states after current step
            drawingHistory = drawingHistory.slice(0, historyStep + 1);
            // Save current canvas state
            drawingHistory.push(canvas.toDataURL());
            historyStep++;
            // Limit history to 20 steps
            if (drawingHistory.length > 20) {
                drawingHistory.shift();
                historyStep--;
            }
            updateUndoRedoButtons();
        }

        function undo() {
            if (historyStep > 0) {
                historyStep--;
                restoreState(drawingHistory[historyStep]);
                updateUndoRedoButtons();
            }
        }

        function redo() {
            if (historyStep < drawingHistory.length - 1) {
                historyStep++;
                restoreState(drawingHistory[historyStep]);
                updateUndoRedoButtons();
            }
        }

        function restoreState(dataUrl) {
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
            };
            img.src = dataUrl;
        }

        function updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            
            if (undoBtn) {
                undoBtn.style.opacity = historyStep > 0 ? '1' : '0.5';
                undoBtn.disabled = historyStep <= 0;
            }
            if (redoBtn) {
                redoBtn.style.opacity = historyStep < drawingHistory.length - 1 ? '1' : '0.5';
                redoBtn.disabled = historyStep >= drawingHistory.length - 1;
            }
        }

        function setTool(t) {
            tool = t;
            document.querySelectorAll('.tool-row .btn').forEach((btn, i) => {
                btn.classList.toggle('active', (i === 0 && t === 'draw') || (i === 1 && t === 'erase'));
            });
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawingHistory = [];
            historyStep = -1;
            saveState();
        }

        function nextImage() {
            if (images.length === 0) {
                alert('No images available. Add some in Manage tab!');
                return;
            }
            currentIdx = (currentIdx + 1) % images.length;
            document.getElementById('cloudImg').src = images[currentIdx];
            clearCanvas();
        }

        async function submit() {
            const desc = document.getElementById('desc').value.trim();
            if (!desc) {
                alert('Please describe what you see!');
                return;
            }

            // Get or prompt for username
            let username = localStorage.getItem('cloudvision-username');
            if (!username) {
                username = prompt('Choose a username (will be saved for future visions):');
                if (username) {
                    username = username.trim().substring(0, 20); // Max 20 chars
                    localStorage.setItem('cloudvision-username', username);
                } else {
                    username = 'Anonymous';
                }
            }

            const btn = document.querySelector('.submit');
            btn.disabled = true;
            btn.textContent = 'üíæ Saving...';

            try {
                const tags = extractTags(desc);
                const imgUrl = images[currentIdx] || '';

                const vision = {
                    image: imgUrl,
                    imageIndex: currentIdx,
                    drawing: canvas.toDataURL('image/png'),
                    description: desc,
                    username: username,
                    tags: tags,
                    timestamp: window.firestore.serverTimestamp()
                };

                await window.firestore.addDoc(window.firestore.collection(window.db, 'visions'), vision);
                
                // Reload visions to get matches
                await loadVisions();
                
                // Show match results
                const sameImageVisions = allVisions.filter(v => v.imageIndex === currentIdx);
                let matchCount = 0;
                const similarVisions = [];

                sameImageVisions.forEach(other => {
                    if (other.description === desc) return; // Skip self
                    const commonTags = tags.filter(tag => other.tags && other.tags.includes(tag));
                    if (commonTags.length > 0) {
                        matchCount++;
                        similarVisions.push(other);
                    }
                });

                let message = '‚ú® Vision saved!\n\n';
                
                // Add total visions count
                message += `üìä Gallery Stats:\n`;
                message += `‚Ä¢ ${allVisions.length} total visions in the gallery\n`;
                message += `‚Ä¢ ${new Set(allVisions.map(v => v.imageIndex)).size} different clouds interpreted\n\n`;
                
                if (sameImageVisions.length <= 1) {
                    message += 'üåü You\'re first to view this cloud!';
                } else {
                    message += `This Cloud:\n`;
                    message += `‚Ä¢ ${sameImageVisions.length - 1} ${sameImageVisions.length === 2 ? 'person has' : 'people have'} viewed it\n`;
                    if (matchCount > 0) {
                        message += `‚Ä¢ ${matchCount} saw something similar!\n\n`;
                        message += 'üëÄ Similar visions:\n';
                        similarVisions.slice(0, 3).forEach(v => {
                            message += `   ‚Ä¢ "${v.description}" - ${v.username || 'Anonymous'}\n`;
                        });
                    } else {
                        message += '‚Ä¢ Unique vision! üé®\n\n';
                        if (sameImageVisions.length > 1) {
                            message += 'Others saw:\n';
                            sameImageVisions.filter(v => v.description !== desc).slice(0, 3).forEach(v => {
                                message += `   ‚Ä¢ "${v.description}" - ${v.username || 'Anonymous'}\n`;
                            });
                        }
                    }
                }

                btn.disabled = false;
                btn.textContent = 'Submit Your Vision';

                if (confirm(message + '\n\nNext cloud?')) {
                    document.getElementById('desc').value = '';
                    clearCanvas();
                    nextImage();
                } else if (confirm('View gallery?')) {
                    document.getElementById('desc').value = '';
                    clearCanvas();
                    document.querySelectorAll('.tab')[1].click(); // Gallery tab
                } else {
                    document.getElementById('desc').value = '';
                    clearCanvas();
                }

                loadStats();
            } catch (error) {
                console.error('Error saving:', error);
                alert('Error saving vision. Please try again.');
                btn.disabled = false;
                btn.textContent = 'Submit Your Vision';
            }
        }

        function extractTags(text) {
            const synonymMap = {
                'test': ['test', 'tests', 'exam', 'exams', 'quiz', 'quizzes', 'assessment'],
                'sandal': ['sandal', 'sandals', 'flip-flop', 'flip-flops', 'flipflop', 'flipflops', 'thong', 'thongs', 'shoe', 'shoes'],
                'dog': ['dog', 'dogs', 'puppy', 'puppies', 'doggy', 'pooch', 'canine', 'hound', 'pup'],
                'cat': ['cat', 'cats', 'kitty', 'kitten', 'kittens', 'feline', 'tabby'],
                'bird': ['bird', 'birds', 'birdie', 'avian'],
                'dragon': ['dragon', 'dragons', 'drake', 'serpent', 'wyvern'],
                'face': ['face', 'faces', 'head', 'heads', 'portrait'],
                'person': ['person', 'people', 'human', 'humans', 'man', 'woman', 'figure', 'body', 'silhouette'],
                'horse': ['horse', 'horses', 'pony', 'ponies', 'mare', 'stallion', 'mustang'],
                'fish': ['fish', 'fishes'],
                'rabbit': ['rabbit', 'rabbits', 'bunny', 'bunnies', 'hare', 'hares'],
                'elephant': ['elephant', 'elephants'],
                'castle': ['castle', 'castles', 'fortress', 'palace', 'tower', 'fort'],
                'mountain': ['mountain', 'mountains', 'peak', 'peaks', 'hill', 'hills', 'volcano'],
                'heart': ['heart', 'hearts'],
                'angel': ['angel', 'angels', 'cherub', 'seraph'],
                'monster': ['monster', 'monsters', 'creature', 'beast', 'demon'],
                'dinosaur': ['dinosaur', 'dinosaurs', 'dino', 'dinos', 't-rex', 'trex', 'raptor'],
                'skull': ['skull', 'skulls', 'skeleton', 'death'],
                'tree': ['tree', 'trees', 'forest', 'oak', 'pine'],
                'flower': ['flower', 'flowers', 'rose', 'bloom', 'blossom'],
                'butterfly': ['butterfly', 'butterflies', 'moth'],
                'snake': ['snake', 'snakes', 'serpent', 'cobra', 'viper'],
                'lion': ['lion', 'lions', 'lioness'],
                'bear': ['bear', 'bears', 'grizzly', 'polar'],
                'wolf': ['wolf', 'wolves'],
                'eagle': ['eagle', 'eagles', 'hawk', 'falcon'],
                'whale': ['whale', 'whales', 'orca', 'dolphin'],
                'shark': ['shark', 'sharks'],
                'octopus': ['octopus', 'octopi', 'squid'],
                'alien': ['alien', 'aliens', 'ufo', 'extraterrestrial'],
                'rocket': ['rocket', 'rockets', 'spaceship', 'spacecraft'],
                'car': ['car', 'cars', 'vehicle', 'auto', 'automobile'],
                'airplane': ['airplane', 'airplanes', 'plane', 'planes', 'jet', 'aircraft'],
                'boat': ['boat', 'boats', 'ship', 'ships', 'vessel', 'sailboat'],
                'hand': ['hand', 'hands', 'fist', 'palm', 'finger', 'fingers'],
                'eye': ['eye', 'eyes'],
                'smile': ['smile', 'smiling', 'grin', 'grinning', 'happy'],
                'ghost': ['ghost', 'ghosts', 'spirit', 'spirits', 'specter'],
                'wizard': ['wizard', 'wizards', 'witch', 'sorcerer', 'mage'],
                'unicorn': ['unicorn', 'unicorns'],
                'phoenix': ['phoenix', 'phoenixes'],
                'mermaid': ['mermaid', 'mermaids', 'siren'],
                'crown': ['crown', 'crowns', 'tiara'],
                'sword': ['sword', 'swords', 'blade', 'katana'],
                'shield': ['shield', 'shields'],
                'book': ['book', 'books', 'tome', 'novel'],
                'mushroom': ['mushroom', 'mushrooms', 'toadstool'],
                'star': ['star', 'stars'],
                'moon': ['moon', 'crescent'],
                'sun': ['sun', 'sunshine'],
                'planet': ['planet', 'planets', 'sphere'],
                'galaxy': ['galaxy', 'galaxies', 'nebula'],
                'wave': ['wave', 'waves', 'ocean', 'water'],
                'flame': ['flame', 'flames', 'fire', 'blaze']
            };

            const words = text.toLowerCase()
                .replace(/[^\w\s]/g, ' ')
                .split(/\s+/)
                .filter(w => w.length > 2);

            const normalizedTags = new Set();
            words.forEach(word => {
                let normalized = word;
                for (const [canonical, synonyms] of Object.entries(synonymMap)) {
                    if (synonyms.includes(word)) {
                        normalized = canonical;
                        break;
                    }
                }
                normalizedTags.add(normalized);
            });

            return Array.from(normalizedTags).slice(0, 5);
        }

        async function loadImages() {
            try {
                const q = window.firestore.query(window.firestore.collection(window.db, 'images'));
                const snapshot = await window.firestore.getDocs(q);
                
                images = [];
                snapshot.forEach(doc => {
                    images.push(doc.data().url);
                });

                if (images.length === 0) {
                    images = [
                        'https://images.unsplash.com/photo-1517483000871-1dbf64a6e1c6?w=800&q=80',
                        'https://images.unsplash.com/photo-1513002749550-c59d786b8e6c?w=800&q=80',
                        'https://images.unsplash.com/photo-1501630834273-4b5604d2ee31?w=800&q=80'
                    ];
                }
                
                if (images.length > 0) {
                    document.getElementById('cloudImg').src = images[0];
                }
                updateGrid();
            } catch (error) {
                console.error('Error loading images:', error);
            }
        }

        async function addUrl() {
            const url = document.getElementById('urlInput').value.trim();
            if (!url) return;
            
            try {
                await window.firestore.addDoc(window.firestore.collection(window.db, 'images'), {
                    url: url,
                    timestamp: window.firestore.serverTimestamp()
                });
                
                document.getElementById('urlInput').value = '';
                loadImages();
                alert('‚úÖ Added!');
            } catch (error) {
                console.error('Error adding image:', error);
                alert('Error adding image');
            }
        }

        async function addFile(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    await window.firestore.addDoc(window.firestore.collection(window.db, 'images'), {
                        url: e.target.result,
                        timestamp: window.firestore.serverTimestamp()
                    });
                    
                    input.value = '';
                    loadImages();
                    alert('‚úÖ Uploaded!');
                } catch (error) {
                    console.error('Error uploading:', error);
                    alert('Error uploading image');
                }
            };
            reader.readAsDataURL(file);
        }

        async function removeImage(url) {
            if (!confirm('Remove this image?')) return;
            
            try {
                const q = window.firestore.query(window.firestore.collection(window.db, 'images'));
                const snapshot = await window.firestore.getDocs(q);
                
                snapshot.forEach(async (document) => {
                    if (document.data().url === url) {
                        await window.firestore.deleteDoc(document.ref);
                    }
                });
                
                loadImages();
            } catch (error) {
                console.error('Error removing image:', error);
            }
        }

        async function deleteVision(visionId) {
            if (!confirm('Delete this vision?')) return;
            
            try {
                await window.firestore.deleteDoc(window.firestore.doc(window.db, 'visions', visionId));
                await loadVisions();
                loadStats();
                alert('‚úÖ Vision deleted!');
            } catch (error) {
                console.error('Error deleting vision:', error);
                alert('Error deleting vision');
            }
        }

        function updateGrid() {
            const grid = document.getElementById('imageGrid');
            document.getElementById('count').textContent = images.length;
            
            grid.innerHTML = images.map(url => `
                <div class="image-item">
                    <img src="${url}">
                    <button class="delete-btn" onclick="removeImage(\`${url}\`)">√ó</button>
                </div>
            `).join('');
        }

        function toggleCommunity(enabled) {
            localStorage.setItem('community-enabled', enabled);
            alert(enabled ? '‚úÖ Community uploads enabled' : '‚ùå Community uploads disabled');
        }

        function saveUsername() {
            const username = document.getElementById('usernameInput').value.trim();
            if (username) {
                localStorage.setItem('cloudvision-username', username.substring(0, 20));
                alert('‚úÖ Username saved!');
            } else {
                localStorage.removeItem('cloudvision-username');
                alert('‚úÖ Reset to Anonymous');
            }
        }

        function loadUsername() {
            const username = localStorage.getItem('cloudvision-username') || '';
            document.getElementById('usernameInput').value = username;
        }

        async function loadVisions() {
            try {
                const q = window.firestore.query(
                    window.firestore.collection(window.db, 'visions'),
                    window.firestore.orderBy('timestamp', 'desc'),
                    window.firestore.limit(100)
                );
                const snapshot = await window.firestore.getDocs(q);
                
                allVisions = [];
                snapshot.forEach(doc => {
                    allVisions.push({ id: doc.id, ...doc.data() });
                });
                
                updateGallery();
            } catch (error) {
                console.error('Error loading visions:', error);
            }
        }

        function updateGallery() {
            const list = document.getElementById('galleryList');
            
            if (allVisions.length === 0) {
                list.innerHTML = '<div class="info">No visions yet! Be the first üå§Ô∏è</div>';
                return;
            }

            const header = `
                <div class="info" style="text-align: center; font-size: 1.1em;">
                    <strong>üé® ${allVisions.length} Visions Shared</strong>
                </div>
            `;

            const currentUsername = localStorage.getItem('cloudvision-username') || 'Anonymous';
            
            const cards = allVisions.map(v => `
                <div class="card">
                    <div style="position: relative; overflow: hidden;">
                        <img src="${v.image}" style="display: block; width: 100%; height: auto;">
                        <canvas id="overlay-${v.id}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></canvas>
                        ${v.username === currentUsername ? `
                            <button onclick="deleteVision('${v.id}')" style="position: absolute; top: 10px; right: 10px; background: rgba(231,76,60,0.9); color: white; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 18px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 10;">
                                √ó
                            </button>
                        ` : ''}
                    </div>
                    <div class="card-body">
                        <strong>"${v.description}"</strong>
                        <div style="color: #3498db; font-size: 0.9em; margin-top: 5px;">
                            üë§ ${v.username || 'Anonymous'}
                        </div>
                        <div style="color: #7f8c8d; font-size: 0.9em; margin-top: 5px;">
                            ${v.timestamp ? new Date(v.timestamp.toDate()).toLocaleDateString() : 'Recently'}
                        </div>
                    </div>
                </div>
            `).join('');

            list.innerHTML = header + cards;
            
            // Render drawings on canvases after DOM update
            setTimeout(() => {
                allVisions.forEach(v => {
                    const overlayCanvas = document.getElementById(`overlay-${v.id}`);
                    if (overlayCanvas) {
                        const parent = overlayCanvas.parentElement;
                        const img = parent.querySelector('img');
                        overlayCanvas.width = img.offsetWidth;
                        overlayCanvas.height = img.offsetHeight;
                        
                        const overlayCtx = overlayCanvas.getContext('2d');
                        const drawingImg = new Image();
                        drawingImg.onload = () => {
                            overlayCtx.drawImage(drawingImg, 0, 0, overlayCanvas.width, overlayCanvas.height);
                        };
                        drawingImg.src = v.drawing;
                    }
                });
            }, 100);
        }

        async function loadStats() {
            try {
                document.getElementById('totalVisions').textContent = allVisions.length;
                
                const uniqueImages = new Set(allVisions.map(v => v.imageIndex)).size;
                document.getElementById('uniqueImages').textContent = uniqueImages;

                const today = new Date().toDateString();
                const todayCount = allVisions.filter(v => {
                    if (!v.timestamp) return false;
                    return new Date(v.timestamp.toDate()).toDateString() === today;
                }).length;
                document.getElementById('todayVisions').textContent = todayCount;

                // Count tag frequency
                const tagCounts = {};
                allVisions.forEach(v => {
                    if (v.tags) {
                        v.tags.forEach(tag => {
                            tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                        });
                    }
                });

                const topTags = Object.entries(tagCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);

                const avgMatches = topTags.length > 0 
                    ? Math.round(topTags.reduce((sum, [_, count]) => sum + count, 0) / topTags.length)
                    : 0;
                document.getElementById('avgMatches').textContent = avgMatches;

                // Count user contributions
                const userCounts = {};
                allVisions.forEach(v => {
                    const username = v.username || 'Anonymous';
                    userCounts[username] = (userCounts[username] || 0) + 1;
                });

                const topUsers = Object.entries(userCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);

                const topThingsDiv = document.getElementById('topThings');
                let html = '';

                if (topTags.length > 0) {
                    html += `
                        <h4 style="margin: 15px 0 10px;">üèÜ Most Seen Things</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${topTags.map(([tag, count]) => 
                                `<span style="background: #3498db; color: white; padding: 6px 12px; border-radius: 15px; font-size: 0.9em;">${tag} (${count})</span>`
                            ).join('')}
                        </div>
                    `;
                }

                if (topUsers.length > 0) {
                    html += `
                        <h4 style="margin: 20px 0 10px;">üë• Top Contributors</h4>
                        <div style="background: white; border-radius: 10px; overflow: hidden;">
                            ${topUsers.map(([username, count], index) => `
                                <div style="padding: 12px 15px; border-bottom: 1px solid #ecf0f1; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <span style="color: #95a5a6; font-weight: bold; margin-right: 10px;">#${index + 1}</span>
                                        <span style="color: #2c3e50;">${username}</span>
                                    </div>
                                    <span style="background: #3498db; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.9em;">${count} vision${count === 1 ? '' : 's'}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                topThingsDiv.innerHTML = html;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
            
            if (tab === 'draw') {
                const username = localStorage.getItem('cloudvision-username') || 'Anonymous';
                document.getElementById('currentUsername').textContent = username;
            }
            if (tab === 'gallery') loadVisions();
            if (tab === 'stats') loadStats();
            if (tab === 'manage') {
                updateGrid();
                loadUsername();
            }
        }

        window.addEventListener('load', init);
        window.addEventListener('resize', resize);
        
        // Initialize username display
        window.addEventListener('load', () => {
            const username = localStorage.getItem('cloudvision-username') || 'Anonymous';
            document.getElementById('currentUsername').textContent = username;
        });
    </script>
</body>
</html>
